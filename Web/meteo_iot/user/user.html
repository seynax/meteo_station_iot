<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphiques des Relevés de la Sonde</title>
    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
        <!-- Bannière bleue avec menus déroulants -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="bg-primary text-white p-3">
                    <!-- Menu déroulant pour choisir la sonde -->
                    <label for="selectSonde" class="form-label text-white">Choisir la sonde :</label>
                    <select class="form-select" id="selectSonde">
                        <!-- Options de sondes à ajouter dynamiquement -->
                    </select>

                    <!-- Menu déroulant pour choisir la période -->
                    <label for="selectPeriode" class="form-label text-white ms-3">Choisir la période :</label>
                    <select class="form-select" id="selectPeriode">
                        <option value="heure">Par Heure</option>
                        <option value="jour">Par Jour</option>
                        <option value="semaine">Par Semaine</option>
                    </select>
                </div>
            </div>
        </div>
                <!-- Ajoutez d'autres boutons déroulants ou éléments ici si nécessaire -->
    
                <div class="col-md-6">
                    <!-- Ajoutez d'autres boutons déroulants ou éléments ici si nécessaire -->
                </div>
            </div>
        <div class="row">
            <!-- Graphique pour la température -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Graphique de Température (°C)
                    </div>
                    <div class="card-body">
                        <canvas id="temperatureChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Graphique pour l'humidité -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Graphique d'Humidité (%)
                    </div>
                    <div class="card-body">
                        <canvas id="humidityChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Graphique pour la pression -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Graphique de Pression (hPa)
                    </div>
                    <div class="card-body">
                        <canvas id="pressureChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function () {
    // Appel de la fonction pour configurer chaque graphique
    setupTemperatureChart();
    setupHumidityChart();
    setupPressureChart();
    // Charger les sondes disponibles dans le menu déroulant
    loadSondes();
});

async function loadSondes() {
    try {
        const response = await fetch('http://192.168.124.128:4000/api/admin/recup-toutes-les-donnees');
        const data = await response.json();

        // Utiliser un ensemble pour stocker les identifiants uniques des sondes
        const sondesSet = new Set();
        data.forEach(sonde => sondesSet.add(sonde.id_sonde));

        // Sélectionner l'élément du menu déroulant
        const selectSonde = document.getElementById('selectSonde');

        // Effacer les options existantes
        selectSonde.innerHTML = '';

        // Ajouter les options pour chaque sonde unique
        sondesSet.forEach(id_sonde => {
            const option = document.createElement('option');
            option.value = id_sonde;
            option.text = `Sonde ${id_sonde}`;
            selectSonde.add(option);
        });

    } catch (error) {
        console.error('Une erreur s\'est produite lors de la récupération des sondes', error);
    }
}

async function fetchData() {
    const response = await fetch('http://192.168.124.128:4000/api/releves/');
    return await response.json();
}

function getTemperatureData(data) {
    return data.map(entry => entry.temperature);
}

function getHumidityData(data) {
    return data.map(entry => entry.humidite);
}

function getPressureData(data) {
    return data.map(entry => entry.pression);
}

function setupChart(canvasId, label, dataFunction, borderColor) {
    fetchData()
        .then(data => {
            const labels = Array.from({ length: data.length }, (_, index) => index + 1);
            const dataValues = dataFunction(data);

            const ctx = document.getElementById(canvasId).getContext('2d');
            const myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: label,
                            data: dataValues,
                            borderColor: borderColor,
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            id: `${label.toLowerCase()}-axis`,
                            scaleLabel: {
                                display: true,
                                labelString: label
                            },
                            ticks: {
                                beginAtZero: true,
                                max: 1000  // Ajustez la valeur maximale selon vos besoins
                            }
                        }
                    },
                },
            });
        })
        .catch(error => console.error(`Une erreur s'est produite lors de la récupération des données pour ${label}`, error));
}

function setupTemperatureChart() {
    setupChart('temperatureChart', 'Température (°C)', getTemperatureData, 'rgb(255, 99, 132)');
}

function setupHumidityChart() {
    setupChart('humidityChart', 'Humidité (%)', getHumidityData, 'rgb(75, 192, 192)');
}

function setupPressureChart() {
    setupChart('pressureChart', 'Pression (hPa)', getPressureData, 'rgb(54, 162, 235)');
}




    </script>
</body>
</html>
